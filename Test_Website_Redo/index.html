<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Search</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1>Search for a Song</h1>
        <div class="search-box">
            <label for="song-search" hidden>Enter song name:</label>
            <input type="text" id="song-search" placeholder="Search for a song..." oninput="showSuggestions()">
            <div class="suggestions" id="suggestions"></div>
        </div>

        <div id="song-details" class="song-details">
            <!-- Song details will be displayed here -->
        </div>

        <div class="gpath-container">
            <button id="toggle-g-image-btn" class="btn btn-primary" style="display: none;">Show Path Image</button>
            <div id="g-image-box" style="display: none;">
                <img id="g-image" class="gpImage" alt="Guitar Path Image">
            </div>
        </div>

        <!-- New Button and Leaderboard Box -->
        <div class="leaderboard-container">
            <button id="show-b-hiscore-btn" data-song-id="" style="display: none;">Show Leaderboard</button>
            <div id="b-hiscore-box" class="hiscore-box" style="display: none;">
                <div class="scrollable-table-container-b">
                    <table id="b-leaderboard-table">
                        <thead style="text-align: center;">
                            <tr>
                                <th style="padding: 0px 0px; width: 10%; text-align: left;">Rank</th>
                                <th style="padding: 10px 20px; flex-grow: 2;">Player</th>
                                <th style="padding: 10px 20px; width: 20%;">Score</th>
                                <th style="padding: 20px 30px; width: 20%;">Accuracy</th>
                                <th style="padding: 10px 20px; width: 10%;"></th>
                            </tr>
                        </thead>
                        <tbody id="b-hiscore-table" style="text-align: center; padding: 1em;">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="fnpv.js"></script>
    <script>
        function showSuggestions() {
            const searchValue = document.getElementById('song-search').value.toLowerCase();
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';  // Clear previous suggestions
        
            if (searchValue) {
                // Filter songs based on search input
                const filteredSongs = songs.filter(song => song.value.toLowerCase().includes(searchValue));
        
                // Show suggestions
                filteredSongs.forEach(song => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.textContent = song.value;
                    suggestionItem.onclick = () => selectSong(song);
                    suggestionsDiv.appendChild(suggestionItem);
                });
            } else {
                // Hide the path image and leaderboard box when search input is empty
                document.getElementById('g-image-box').style.display = 'none';
                document.getElementById('toggle-g-image-btn').style.display = 'none';
                document.getElementById('b-hiscore-box').style.display = 'none';
                document.getElementById('show-b-hiscore-btn').style.display = 'none';
            }
        }
        
        function selectSong(song) {
            const songDetailsDiv = document.getElementById('song-details');
            const suggestionsDiv = document.getElementById('suggestions');
            const searchBox = document.getElementById('song-search');
        
            searchBox.value = song.value;
            suggestionsDiv.innerHTML = '';
            
            const formattedGpath = song.data.gpath.replace(/, /g, '<br>');
            const gImagePath = 'paths/' + song.data.g_image.replace(/'/g, '');
        
            const songData = `
                <h2>${song.value}</h2>
                <p>Score: ${song.data.gscore}</p>
                <div class="gpath-box">
                    <strong>Guitar Path:</strong> <br>
                    ${formattedGpath}
                </div>
            `;
            songDetailsDiv.innerHTML = songData;
            
            // Show the "Show Path Image" button and set its event listener
            document.getElementById('toggle-g-image-btn').style.display = 'block';
            document.getElementById('toggle-g-image-btn').onclick = function() {
                const image = document.getElementById('g-image');
                const isVisible = image.style.display === 'block';
                image.style.display = isVisible ? 'none' : 'block';
                this.textContent = isVisible ? 'Show Path Image' : 'Hide Path Image';
            };
            
            // Show the path image box
            const gImageBox = document.getElementById('g-image-box');
            gImageBox.style.display = 'block';
            const image = document.getElementById('g-image');
            image.src = gImagePath;
            image.style.display = 'none'; // Start hidden
            
            // Show the leaderboard button
            const leaderboardButton = document.getElementById('show-b-hiscore-btn');
            leaderboardButton.style.display = 'block';
            leaderboardButton.setAttribute('data-song-id', song.data.shortname);

            console.log('Selected song:', song);  // Debugging line to check song data
            console.log('Song shortname for leaderboard:', song.data.shortname);  // Debugging line
        }
        
        document.getElementById('show-b-hiscore-btn').addEventListener('click', function() {
            const songId = this.getAttribute('data-song-id');
            console.log('Fetching leaderboard for song ID:', songId);  // Debugging line
            const leaderboardBox = document.getElementById('b-hiscore-box');
            const button = this;
        
            if (button.textContent === 'Show Leaderboard') {
                GetGuitarLeaderboard(songId);
                leaderboardBox.style.display = 'block';
                button.textContent = 'Hide Leaderboard';
            } else {
                leaderboardBox.style.display = 'none';
                button.textContent = 'Show Leaderboard';
            }
        });
        
        async function GetGuitarLeaderboard(songId) {
            try {
                const url = `https://raw.githubusercontent.com/mattfreg/FNF_ProLeaderboards/main/leaderboards/season5/${songId}/Solo_PeripheralGuitar_0.json`;
                console.log(`Fetching leaderboard from URL: ${url}`);  // Debugging line to check URL

                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Fetched leaderboard data:', data);  // Debugging line
        
                if (Array.isArray(data.entries) && data.entries.length > 0) {
                    updateGuitarLeaderboardTable(data.entries);
                } else {
                    console.warn('Leaderboard data is empty or not in expected format:', data);
                    updateGuitarLeaderboardTable([]); // Clear the table if no valid data
                }
            } catch (error) {
                console.error('Error fetching leaderboard data:', error);
            }
        }
        
        function updateGuitarLeaderboardTable(entries) {
            const tableBody = document.getElementById('b-hiscore-table');
            tableBody.innerHTML = ''; // Clear existing rows
        
            if (entries.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5">No leaderboard data available</td></tr>';
                return;
            }
        
            entries.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.rank || 'N/A'}</td>
                    <td>${entry.player || 'N/A'}</td>
                    <td>${entry.score || 'N/A'}</td>
                    <td>${entry.accuracy || 'N/A'}</td>
                    <td>${entry.fullcombo ? '✔' : '✘'}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        </script>
</body>
</html>